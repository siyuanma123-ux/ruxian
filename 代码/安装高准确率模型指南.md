# 安装高准确率模型指南

## ✅ 当前状态

诊断脚本已创建并运行完成！所有病人的诊断报告已生成。

**已生成文件**:
- `未命名文件夹 2/{病人姓名}_{部位}_高准确率模型诊断报告.txt`

## 📋 当前使用的模型

由于End-to-end模型需要旧版本的Keras和TensorFlow，当前诊断使用的是：
- **我们的PyTorch跨模态模型**（已加载）

## 🔧 如果要使用End-to-end高准确率模型（可选）

### 步骤1: 安装依赖（使用虚拟环境推荐）

```bash
# 创建虚拟环境（推荐，避免与现有环境冲突）
conda create -n end2end python=3.7
conda activate end2end

# 或使用venv
python3 -m venv end2end_env
source end2end_env/bin/activate  # macOS/Linux
# end2end_env\Scripts\activate  # Windows

# 安装依赖
pip install keras==2.0.8
pip install tensorflow==1.15.0  # 或 tensorflow-gpu==1.15.0
pip install h5py numpy scipy pillow opencv-python
```

### 步骤2: 下载预训练权重

1. **访问Google Drive**:
   - 链接: https://drive.google.com/drive/folders/0B1PVLadG_dCKV2pZem5MTjc1cHc

2. **推荐下载的模型**:
   - **INbreast VGG16 [512-512-1024]x2**: AUC 0.95-0.96 ⭐ 最高准确率
   - **DDSM Resnet50 [512-512-1024]x2**: AUC 0.86-0.91

3. **保存位置**:
   ```bash
   mkdir -p pretrained_models/end-to-end_all_convolutional_design/weights
   # 将下载的.h5文件放到这个目录
   ```

### 步骤3: 使用End-to-end模型进行诊断

```bash
# 激活虚拟环境
conda activate end2end
# 或
source end2end_env/bin/activate

# 运行诊断（指定模型路径）
cd 代码
python3 diagnose_with_high_accuracy_model.py \
    --mammo_dir "../钼靶报告" \
    --output_dir "../未命名文件夹 2" \
    --end2end_model "../pretrained_models/end-to-end_all_convolutional_design/weights/inbreast_vgg16_[512-512-1024]x2.h5"
```

## ⚠️ 注意事项

1. **版本兼容性**:
   - End-to-end模型需要Keras 2.0.8和TensorFlow 1.x
   - 这些版本较旧，可能与现有环境冲突
   - **强烈建议使用虚拟环境**

2. **模型输出**:
   - End-to-end模型输出是**二分类**（正常/异常）
   - 我们的PyTorch模型输出是**四分类**（正常/良性/原位癌/浸润癌）

3. **图像预处理**:
   - End-to-end模型需要1152x896的输入尺寸
   - 需要特定的rescale factor和归一化

## 🎯 推荐方案

### 方案1: 使用当前PyTorch模型（已完成）✅
- **优点**: 无需安装额外依赖，已运行完成
- **缺点**: 模型未训练，准确率可能较低

### 方案2: 安装End-to-end模型
- **优点**: 高准确率（AUC 0.95-0.96）
- **缺点**: 需要安装旧版本依赖，需要下载权重文件

### 方案3: 使用其他PyTorch模型
- 可以考虑使用MV-Swin-T或其他PyTorch实现的模型
- 更现代的架构，更容易集成

## 📊 诊断结果位置

所有诊断报告已保存在：
```
未命名文件夹 2/
├── {病人姓名}_{部位}_高准确率模型诊断报告.txt
└── ...
```

## 🆘 常见问题

### Q: 为什么没有使用End-to-end模型？
A: 因为需要安装Keras 2.0.8和TensorFlow 1.x，这些版本较旧。当前使用PyTorch模型作为备选。

### Q: 如何知道End-to-end模型是否可用？
A: 运行诊断脚本时，如果看到"✅ End-to-end模型加载成功"，说明模型可用。

### Q: 可以同时使用多个模型吗？
A: 可以！诊断脚本会尝试加载End-to-end模型，如果成功会同时使用两个模型进行诊断。

### Q: 诊断结果在哪里？
A: 所有报告保存在 `未命名文件夹 2/` 目录中，文件名格式为 `{病人姓名}_{部位}_高准确率模型诊断报告.txt`


